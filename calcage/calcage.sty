\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{calcage}
          [2012/02/19 v0.7 calcage by Robin Schneider]

%% BUGS: package options are overwriten be the macro parameters
\RequirePackage{fnumprint}[2012/08/27]
\RequirePackage{
  datenumber,
  fp,
  xkeyval,
  kvoptions,
  xifthen,
}

\DeclareStringOption[0]{precision}[3]
\DeclareBoolOption[true]{printyear}
\DeclareBoolOption{yearsuffix}
\ProcessLocalKeyvalOptions*

\ifthenelse{\value{fnumprint@language} = 1}{
    \newcommand{\calcage@year}{Jahr}
    \newcommand{\calcage@yearPluralSuffix}{e}
    \newcommand{\calcage@yearSuffix}{n}
}{
	\ifthenelse{\value{fnumprint@language} = 2}{
	    \newcommand{\calcage@year}{year}
	    \newcommand{\calcage@yearPluralSuffix}{s}
    	\newcommand{\calcage@yearSuffix}{}
	}{}
}

\newcounter{calcage@tmpdate}\newcounter{calcage@ageindays}

\newcommand{\CalcAge}[4][]{%
	\setmydatenumber{calcage@ageindays}{\the\year}{\the\month}{\the\day}%
	\setmydatenumber{calcage@tmpdate}{#2}{#3}{#4}%
	\addtocounter{calcage@ageindays}{-\value{calcage@tmpdate}}%
	\addtocounter{calcage@ageindays}{1}%
	%% Sorgt dafür das am Geburtstag das Alter um eins erhöht wird
	%% und nicht erst einen Tag danach
	\FPdiv\myage{\thecalcage@ageindays}{365.2425}%
	\setkeys{calcage}{#1}%
	\FPtrunc\myage{\myage}{\calcage@precision}%
	\ifthenelse{\equal{\calcage@precision}{0}}{\fnumprint[ein]{\myage}}{\numprint{\myage}}%
	\ifthenelse{\boolean{calcage@printyear}}{%
		~\ifthenelse{\equal{\myage}{1}}{\calcage@year}{%
			\calcage@year\calcage@yearPluralSuffix%
			\ifthenelse{\boolean{calcage@yearsuffix}}{\calcage@yearSuffix}{}%
		}%
	}{}%
}

\endinput
