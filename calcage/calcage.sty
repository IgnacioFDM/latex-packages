\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{calcage}
          [2012/09/08 v0.8 calcage by Robin Schneider]

\RequirePackage{fnumprint}[2012/08/27]
\RequirePackage{
  datenumber,
  fp,
  calc,
  xkeyval,
  kvoptions,
  xifthen,
}

\DeclareStringOption{precision}[3]
\DeclareStringOption{year}
\DeclareStringOption{month}
\DeclareStringOption{day}
\DeclareBoolOption{printyear}
\DeclareBoolOption{yearsuffix}
\ProcessLocalKeyvalOptions*    %% To test for correct
\edef\calcage@options{\@ptionlist{\@currname.\@currext}}
%\renewcommand{\calcage@options}{precision=4,printyear=false}
%% Package xkeyval Error: `precision=4' undefined in families `calcage'.

\ifcase\value{fnumprint@language}\or%% if one
  \newcommand{\calcage@yearWord}{Jahr}
  \newcommand{\calcage@yearPluralSuffix}{e}
  \newcommand{\calcage@yearSuffix}{n}
\or%% if two
  \newcommand{\calcage@year}{year}
  \newcommand{\calcage@yearPluralSuffix}{s}
  \newcommand{\calcage@yearSuffix}{}
\fi

\newcounter{calcage@today}\newcounter{calcage@ageindays}
\newcounter{calcage@myyear}\newcounter{calcage@leapyears}

\newcommand{\calcage}[4][]{%
  \setkeys{calcage}{precision=0,printyear=true,yearsuffix=false,
    year=\the\year,month=\the\month,day=\the\day,\calcage@options,#1}%
  \setmydatenumber{calcage@today}{\calcage@year}{\calcage@month}{\calcage@day}
  \setcounter{calcage@myyear}{#2}%
  \setcounter{calcage@leapyears}{0}%
  \ifthenelse{\equal{#2}{\calcage@year}}{}{%
  \ifthenelse{\value{calcage@myyear}<\calcage@year}{%
    \loop%
      \stepcounter{calcage@myyear}%
      \ifleapyear{\thecalcage@myyear}\stepcounter{calcage@leapyears}\fi%
      \ifnum\value{calcage@myyear}<\calcage@year%
    \repeat%
  }{%
    \loop%
      \ifleapyear{\thecalcage@myyear}\addtocounter{calcage@leapyears}{-1}\fi%
      \addtocounter{calcage@myyear}{-1}%
      \ifnum\value{calcage@myyear}>\calcage@year%
    \repeat%
  }}%
  \setmydatenumber{calcage@ageindays}{#2}{#3}{#4}%
  \setcounter{calcage@ageindays}{\value{calcage@today} - \value{calcage@ageindays}}%
  \addtocounter{calcage@ageindays}{-\value{calcage@leapyears}}%
  \FPdiv\calcage@age{\thecalcage@ageindays}{365}%
  \FPtrunc\calcage@age{\calcage@age}{\calcage@precision}%
  \ifthenelse{\equal{\calcage@precision}{0}}%
  {\fnumprint[ein]{\calcage@age}}{\numprint{\calcage@age}}%
  \ifthenelse{\boolean{calcage@printyear}}{%
    ~\ifthenelse{\equal{\calcage@age}{1}}{\calcage@yearWord}{%
      \calcage@yearWord\calcage@yearPluralSuffix%
      \ifthenelse{\boolean{calcage@yearsuffix}}{\calcage@yearSuffix}{}%
    }%
  }{}%
}

\endinput
